services:
  ntfy:
    image: binwiederhier/ntfy:latest
    command: serve
    restart: unless-stopped
    volumes:
      - ./cache:/var/cache/ntfy
      - ./config:/etc/ntfy
    env_file:
      - .env
    environment:
      # unsetting molly env due to using single env file, fix it later
      - MOLLY_VAPID_PRIVKEY=
      - MOLLY_ALLOWED_ENDPOINTS=
    networks:
      - proxy
      - internal
    labels:
      - traefik.enable=true
      - traefik.http.routers.ntfy.rule=Host(`ntfy.${DOMAIN}`)
      - traefik.http.routers.ntfy.entrypoints=websecure
      - traefik.http.routers.ntfy.tls=true
      - traefik.http.routers.ntfy.tls.certresolver=letsencrypt
      - traefik.http.services.ntfy.loadbalancer.server.port=80

  mollysocket:
    image: ghcr.io/mollyim/mollysocket:latest
    command: server
    restart: unless-stopped
    volumes:
      - ./mollysocket:/data
    env_file:
      - .env
    environment:
      - MOLLY_HOST=0.0.0.0
      - MOLLY_PORT=8020
      - MOLLY_DB=/data/ms.db
    networks:
      - proxy
      - internal
    labels:
      - traefik.enable=true
      - traefik.http.routers.mollysocket.rule=Host(`mollysocket.${DOMAIN}`)
      - traefik.http.routers.mollysocket.entrypoints=websecure
      - traefik.http.routers.mollysocket.tls=true
      - traefik.http.routers.mollysocket.tls.certresolver=letsencrypt
      - traefik.http.services.mollysocket.loadbalancer.server.port=8020

  ntfy-relay:
    image: alpine:3.20
    restart: unless-stopped
    environment:
      NTFY_BASE: "http://ntfy"
      RELAY_TOPICS: "${NTFY_RELAY_TOPICS}"
      TOKEN: "${NTFY_RELAY_TOKEN}"
    command: >
      sh -lc '
        apk add --no-cache curl jq;
        echo "Starting ntfy relay service";
        echo "Base URL: $$NTFY_BASE";
        echo "Topics: $$RELAY_TOPICS";
        echo "$$RELAY_TOPICS" | tr "," "\n" | while IFS=: read -r src dst; do
          (
            echo "Relaying $$src -> $$dst";
            while true; do
              echo "Connecting to $$NTFY_BASE/$$src/json?since=all";
              curl -v -N -H "Authorization: Bearer $$TOKEN" "$$NTFY_BASE/$$src/json?since=all" 2>&1 |
              while read -r line; do
                echo "Line: $$line";
                [ -z "$$line" ] && continue;
                msg=$$(echo "$$line" | jq -r "select(.event==\"message\") | .message // empty" 2>&1);
                title=$$(echo "$$line" | jq -r "select(.event==\"message\") | .title // empty" 2>&1);
                [ -z "$$msg" ] && continue;
                echo "Forwarding to $$dst: $$msg";
                if [ -n "$$title" ]; then
                  curl -v -H "Authorization: Bearer $$TOKEN" -H "Title: $$title" -d "$$msg" "$$NTFY_BASE/$$dst" 2>&1;
                else
                  curl -v -H "Authorization: Bearer $$TOKEN" -d "$$msg" "$$NTFY_BASE/$$dst" 2>&1;
                fi
              done;
              echo "Connection lost for $$src, reconnecting in 5s...";
              sleep 5;
            done
          ) &
        done;
        wait
      '
    networks:
      - internal

networks:
  proxy:
    external: true
    name: proxy
  internal:
    name: ntfy-internal
